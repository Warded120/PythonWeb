{% load static %}
<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>Acme – Наші продукти</title>
{% include 'products/includes/product-list-styles.html' %}
</head>
<body>
<header class="site-header">
    <div class="auth-links">
        {% if user.is_authenticated %}
            <span>Привіт, {{ user.username }}!</span>
            <a href="{% url 'logout' %}">Вихід</a>
        {% else %}
            <a href="{% url 'login' %}">Увійти</a>
            <a href="{% url 'register' %}">Реєстрація</a>
        {% endif %}
    </div>
    <div class="header-content">
        <h1>Acme</h1>
        <p class="tagline">Свіжі продукти з доставкою до дверей</p>
    </div>
</header>

<main class="products-main">
    <section class="products-section">
        <h2 class="section-title">Наші продукти</h2>
        <p class="section-description">Перегляньте наш асортимент свіжих продуктів.</p>

        <div class="products-grid">
            {% for product in products %}
                <div class="product-card">
                    <h3>{{ product.name }}</h3>
                    <p>{{ product.description }}</p>
                    <strong>{{ product.price }} грн/кг</strong>

                    {% if user.is_authenticated %}
                        <form method="post" action="{% url 'add_to_cart' product.id %}" class="add-to-cart-form">
                            {% csrf_token %}
                            <input type="number" name="quantity" value="1" min="0.1" step="0.1" class="quantity-input">
                            <button type="submit" class="btn btn-primary">Додати до кошика</button>
                        </form>
                    {% else %}
                        <p class="login-prompt">Щоб додати товар у кошик,
                            <a href="{% url 'login' %}">увійдіть</a> або
                            <a href="{% url 'register' %}">зареєструйтесь</a>.
                        </p>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    </section>

    <div class="home-link-section">
        <a href="{% url 'home' %}" class="btn btn-primary home-button">На головну</a>
    </div>
</main>

<footer class="site-footer">
    <p>&copy; 2025 Acme</p>
</footer>

<div id="message" class="toast-message"></div>

<script>
function showMessage(text) {
    const msg = document.getElementById('message');
    msg.innerText = text;
    msg.style.display = 'block';
    setTimeout(() => { msg.style.display = 'none'; }, 3000);
}

document.querySelectorAll('.add-to-cart-form').forEach(form => {
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const url = form.action;
        const formData = new FormData(form);

        fetch(url, {
            method: 'POST',
            headers: {'X-CSRFToken': formData.get('csrfmiddlewaretoken')},
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            showMessage(data.message);
            const cartCountElem = document.getElementById('cart-count');
            if(cartCountElem) cartCountElem.innerText = data.cart_count;
        });
    });
});
</script>
</body>
</html>
